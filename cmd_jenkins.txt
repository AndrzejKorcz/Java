pipeline {
    agent any
    parameters {
    string(name: 'OBJNAME', defaultValue: 'RST661001', description: 'Nazwa obiektu dla serwisu.')
    string(name: 'PROJECT', defaultValue: 'TEST_AKO', description: 'Nazwa projektu (task) w ACMSie.')
    string(name: 'SRCNAME', defaultValue: 'RSTSORC', description: 'Nazwa sourcea dla obiektu.')
    string(name: 'FUNCTION', defaultValue: 'MyFunction', description: 'Nazwa funkcji (usługi).') 
    string(name: 'DESCRIPTION', defaultValue: 'Opis funkcji', description: 'Krótki opis funkcji (usługi).') 
    }
    stages {
		stage('Copy, build, test') {	            
            steps {
			  dir('d:\\DevOps\\bin\\') {
                bat label: 'cpyRpgSrvRpl', script: "cpyRpgSrvRpl.cmd ${params.OBJNAME} ${params.PROJECT} ${params.SRCNAME} ${params.FUNCTION} ${params.DESCRIPTION} " 
                bat label: 'cpyRpgSrvToIfs', script: "cpyRpgSrvToIfs.cmd ${params.OBJNAME}"
                bat label: 'cpyRpgSrvCmd', script: "cpyRpgSrvCmd.cmd ${params.OBJNAME} ${params.SRCNAME}"
                bat label: 'acmsRpgSrvCmd', script: "acmsRpgSrvCmd.cmd ${params.OBJNAME} ${params.PROJECT} ${params.SRCNAME}"
                bat label: 'crtRpgSrvCmd', script: "crtRpgSrvCmd.cmd ${params.OBJNAME} ${params.SRCNAME}"
                bat label: 'runRpgSrvCmd', script: "runRpgSrvCmd.cmd ${params.OBJNAME}"
                bat label: 'cpyRpgSrvFromIfs', script: "cpyRpgSrvFromIfs.cmd ${params.OBJNAME}"
              }
	        }
        }
    }
}

cpyRpgSrvRpl:
@echo off
set OBJNAME=%1
set PROJECT=%2
set SRCNAME=%3
set FUNCTION=%4
set DESCRIPTION=%5

FOR /F "tokens=1,2 delims==" %%G IN (cmd.properties) DO (set %%G=%%H)
java -jar ./jar/cpyRplObj.jar -i %inputPath%/BIND.BND %inputPath%/PROTOTYPE.RPGLE %inputPath%/MODULE.RPGLE %inputPath%/TEST.RPGLE %inputPath%/UNITTEST.RPGLE %inputPath%/BUILD.CLLE -o %outputPath%/%OBJNAME%B.BND %outputPath%/%OBJNAME%P.RPGLE %outputPath%/%OBJNAME%M.RPGLE %outputPath%/%OBJNAME%T.RPGLE %outputPath%/%OBJNAME%U.RPGLE %outputPath%/%OBJNAME%C.CLLE -m %OBJNAME% -t %PROJECT% -s %SRCNAME% -f %FUNCTION% -d %DESCRIPTION%

cpyRpgSrvToIfs:
@echo off
set OBJNAME=%1
FOR /F "tokens=1,2 delims==" %%G IN (cmd.properties) DO (set %%G=%%H) 
echo %ifspath%/%OBJNAME%B.BND
echo %outputPath%/%OBJNAME%B.BND
java -jar ./jar/ibmiifs.jar -a cpyToIfs -r %ifspath%/%OBJNAME%B.BND %ifspath%/%OBJNAME%M.RPGLE %ifspath%/%OBJNAME%P.RPGLE %ifspath%/%OBJNAME%T.RPGLE %ifspath%/%OBJNAME%U.RPGLE %ifspath%/%OBJNAME%C.CLLE -l %outputPath%/%OBJNAME%B.BND %outputPath%/%OBJNAME%M.RPGLE %outputPath%/%OBJNAME%P.RPGLE %outputPath%/%OBJNAME%T.RPGLE %outputPath%/%OBJNAME%U.RPGLE %outputPath%/%OBJNAME%C.CLLE            

cpyRpgSrvCmd:
@echo off
set OBJNAME=%1
set SRCNAME=%2
FOR /F "tokens=1,2 delims==" %%G IN (cmd.properties) DO (set %%G=%%H)  
java -jar ./jar/ibmicmd.jar -c "ADDPFM FILE(%ibmilib%/%SRCNAME%) MBR(%OBJNAME%P) SRCTYPE(RPGLE) TEXT('prototype')" "ADDPFM FILE(%ibmilib%/%SRCNAME%) MBR(%OBJNAME%M) SRCTYPE(RPGLE) TEXT('module')" "ADDPFM FILE(%ibmilib%/%SRCNAME%) MBR(%OBJNAME%T) SRCTYPE(RPGLE) TEXT('test')" "ADDPFM FILE(%ibmilib%/%SRCNAME%) MBR(%OBJNAME%U) SRCTYPE(RPGLE) TEXT('unit test')" "ADDPFM FILE(%ibmilib%/%SRCNAME%) MBR(%OBJNAME%B) SRCTYPE(BND) TEXT('binding')" "ADDPFM FILE(%ibmilib%/%SRCNAME%) MBR(%OBJNAME%C) SRCTYPE(CLLE) TEXT('build')" "CPYFRMSTMF FROMSTMF('%ifspath%/%OBJNAME%P.RPGLE') TOMBR('/qsys.lib/%ibmilib%.lib/%SRCNAME%.file/%OBJNAME%P.mbr') MBROPT(*REPLACE) CVTDTA(*AUTO)" "CPYFRMSTMF FROMSTMF('%ifspath%/%OBJNAME%M.RPGLE') TOMBR('/qsys.lib/%ibmilib%.lib/%SRCNAME%.file/%OBJNAME%M.mbr') MBROPT(*REPLACE) CVTDTA(*AUTO)" "CPYFRMSTMF FROMSTMF('%ifspath%/%OBJNAME%T.RPGLE') TOMBR('/qsys.lib/%ibmilib%.lib/%SRCNAME%.file/%OBJNAME%T.mbr') MBROPT(*REPLACE) CVTDTA(*AUTO)" "CPYFRMSTMF FROMSTMF('%ifspath%/%OBJNAME%U.RPGLE') TOMBR('/qsys.lib/%ibmilib%.lib/%SRCNAME%.file/%OBJNAME%U.mbr') MBROPT(*REPLACE) CVTDTA(*AUTO)" "CPYFRMSTMF FROMSTMF('%ifspath%/%OBJNAME%B.BND') TOMBR('/qsys.lib/%ibmilib%.lib/%SRCNAME%.file/%OBJNAME%B.mbr') MBROPT(*REPLACE) CVTDTA(*AUTO)" "CPYFRMSTMF FROMSTMF('%ifspath%/%OBJNAME%C.CLLE') TOMBR('/qsys.lib/%ibmilib%.lib/%SRCNAME%.file/%OBJNAME%C.mbr') MBROPT(*REPLACE) CVTDTA(*AUTO)"

acmsRpgSrvCmd:
@echo off
set OBJNAME=%1
set PROJECT=%2
set SRCNAME=%3
FOR /F "tokens=1,2 delims==" %%G IN (cmd.properties) DO (set %%G=%%H)  
java -jar ./jar/ibmicmd.jar -c "ACMSADDOBJ OBJNAME(%OBJNAME%M) OBJTYPE(*MODULE) OBJATTR(RPGLE) OBJEXTA(BND) OBJTEXT('MODULE') IDLIB(%ibmilib%) SRCMNAME(%OBJNAME%M) REQEXIST(*NO) DVP(%ibmilib%) PROJECT(%PROJECT%) OBJLIBGRP(8) SRCLIBGRP(1) SOURCEOPT(*YES) REL(ICBSV710/ICBSV710/AIBINTMRO2) SRCFNAME(%SRCNAME%)" "ACMSADDOBJ OBJNAME(%OBJNAME%P) OBJTYPE(*SRCMBR) OBJATTR(RPGLE) OBJTEXT('prototype') IDLIB(%ibmilib%) SRCMNAME(%OBJNAME%P) REQEXIST(*NO) DVP(%ibmilib%) PROJECT(%PROJECT%) SRCLIBGRP(1) SOURCEOPT(*YES) REL(ICBSV710/ICBSV710/AIBINTMRO2) SRCFNAME(%SRCNAME%)" "ACMSADDOBJ OBJNAME(%OBJNAME%B) OBJTYPE(*SRCMBR) OBJATTR(BND) OBJTEXT('binding') IDLIB(%ibmilib%) SRCMNAME(%OBJNAME%B) REQEXIST(*NO) DVP(%ibmilib%) PROJECT(%PROJECT%) SRCLIBGRP(1) SOURCEOPT(*YES) REL(ICBSV710/ICBSV710/AIBINTMRO2) SRCFNAME(%SRCNAME%)" "ACMSADDOBJ OBJNAME(%OBJNAME%T) OBJTYPE(*PGM) OBJATTR(RPGLE) OBJEXTA(BND) OBJTEXT('test') IDLIB(%ibmilib%) SRCMNAME(%OBJNAME%T) REQEXIST(*NO) DVP(%ibmilib%) PROJECT(%PROJECT%) OBJLIBGRP(2) SRCLIBGRP(1) SOURCEOPT(*YES) REL(ICBSV710/ICBSV710/AIBINTMRO2) SRCFNAME(%SRCNAME%)" "ACMSADDOBJ OBJNAME(%OBJNAME%S) OBJTYPE(*SRVPGM) OBJATTR(RPGLE) OBJTEXT('srvpgm') IDLIB(%ibmilib%) REQEXIST(*NO) DVP(%ibmilib%) PROJECT(%PROJECT%) OBJLIBGRP(2) SOURCEOPT(*NO) REL(ICBSV710/ICBSV710/AIBINTMRO2)" "ACMSADDOBJ OBJNAME(%OBJNAME%U) OBJTYPE(*SRVPGM) OBJTEXT('unit test') IDLIB(%ibmilib%) SRCMNAME(%OBJNAME%U) REQEXIST(*NO) DVP(%ibmilib%) PROJECT(%PROJECT%) OBJLIBGRP(2) SRCLIBGRP(1) SOURCEOPT(*YES) REL(ICBSV710/ICBSV710/AIBINTMRO2) SRCFNAME(%SRCNAME%)"

crtRpgSrvCmd:
@echo off
set OBJNAME=%1
set SRCNAME=%2
FOR /F "tokens=1,2 delims==" %%G IN (cmd.properties) DO (set %%G=%%H)  
java -jar ./jar/ibmicmd.jar -c "CRTRPGMOD MODULE(%ibmilib%/%OBJNAME%M) SRCFILE(%ibmilib%/%SRCNAME%) SRCMBR(%OBJNAME%M) REPLACE(*YES) OPTION(*EVENTF) DBGVIEW(*SOURCE)" "CRTSRVPGM  SRVPGM(%ibmilib%/%OBJNAME%S) MODULE(%OBJNAME%M) EXPORT(*SRCFILE) SRCFILE(%SRCNAME%) SRCMBR(%OBJNAME%B) TEXT('USLUGA - SRVPGM')" "CRTRPGMOD MODULE(%ibmilib%/%OBJNAME%T) SRCFILE(%ibmilib%/%SRCNAME%) SRCMBR(%OBJNAME%T) REPLACE(*YES) OPTION(*EVENTF) DBGVIEW(*SOURCE)" "CRTPGM PGM(%ibmilib%/%OBJNAME%T) MODULE(%ibmilib%/%OBJNAME%T) BNDSRVPGM((%ibmilib%/%OBJNAME%S))" "RUCRTTST TSTPGM(%ibmilib%/%OBJNAME%U) SRCFILE(%ibmilib%/%SRCNAME%) BNDSRVPGM(%ibmilib%/%OBJNAME%S)" "CRTBNDCL PGM(%ibmilib%/%OBJNAME%C) SRCFILE(%ibmilib%/%SRCNAME%) SRCMBR(%OBJNAME%C) REPLACE(*YES) OPTION(*EVENTF) DBGVIEW(*SOURCE)" "QDEVTOOLS/CODECOV CMD(CALL PGM(%ibmilib%/%OBJNAME%T)) MODULE((%ibmilib%/%OBJNAME%T *PGM *ALL)) OUTSTMF('%ifspath%/%OBJNAME%T.cczip')"

runRpgSrvCmd:
@echo off
set OBJNAME=%1
FOR /F "tokens=1,2 delims==" %%G IN (cmd.properties) DO (set %%G=%%H)
java -jar ./jar/ibmicmd.jar -c "RUCALLTST TSTPGM(%ibmilib%/%OBJNAME%U) RCLRSC(*ALWAYS)" "CRTPF FILE(QTEMP/DBfile) RCDLEN(132)" "CPYSPLF FILE(RPGUNIT) TOFILE(QTEMP/DBFILE) JOB(%ibmilib%/QPRTJOB) CRTDATE(*LAST)" "DLTSPLF FILE(RPGUNIT) JOB(%ibmilib%/QPRTJOB) CRTDATE(*LAST)" "CPYTOSTMF FROMMBR('/QSYS.LIB/QTEMP.LIB/DBFILE.FILE/DBFILE.MBR') TOSTMF('%ifspath%/%OBJNAME%U.rpt') STMFOPT(*REPLACE) AUT(*FILE)"

cpyRpgSrvFromIfs:
@echo off
set OBJNAME=%1
FOR /F "tokens=1,2 delims==" %%G IN (cmd.properties) DO (set %%G=%%H)  
java -jar ./jar/ibmiifs.jar -a cpyFromIfs -r %ifspath%/%OBJNAME%U.rpt -l %outputPath%/%OBJNAME%U.rpt

cmd.properties:
ifspath=/usr/local/src/CICD
inputPath=E:/Users/160246/IBM/rationalsdp/workspace/DevOps/RSTSORC
outputPath=D:/DevOps/src/CICD
ibmilib=KORCZA03
